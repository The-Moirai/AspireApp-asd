# æœåŠ¡å±‚è¿ç§»æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä»åŸæœ‰æœåŠ¡æ¶æ„è¿ç§»åˆ°æ–°çš„åˆ†å±‚æ¶æ„çš„è¯¦ç»†æ­¥éª¤å’Œæ³¨æ„äº‹é¡¹ã€‚

## ğŸ—ï¸ æ–°æ¶æ„ç»“æ„

### åŸæœ‰æ¶æ„
```
Controllers
â”œâ”€â”€ DronesController (ç›´æ¥ä½¿ç”¨ DroneDataService)
â”œâ”€â”€ HistoryDataController (ç›´æ¥ä½¿ç”¨ DroneDataService + TaskDataService)
â””â”€â”€ SystemController (ç›´æ¥ä½¿ç”¨ DroneDataService + TaskDataService)
```

### æ–°æ¶æ„
```
Controllers (æ§åˆ¶å™¨å±‚)
â”œâ”€â”€ NewDronesController (ä½¿ç”¨ DroneService)
â””â”€â”€ NewTasksController (ä½¿ç”¨ TaskService)

Services (ä¸šåŠ¡æœåŠ¡å±‚)
â”œâ”€â”€ Clean/
â”‚   â”œâ”€â”€ DroneService (ä¸šåŠ¡é€»è¾‘ + ç¼“å­˜)
â”‚   â””â”€â”€ TaskService (ä¸šåŠ¡é€»è¾‘ + ç¼“å­˜)

Data (æ•°æ®è®¿é—®å±‚)
â”œâ”€â”€ DroneRepository (å®ç° IDroneRepository)
â””â”€â”€ TaskRepository (å®ç° ITaskRepository)

Interfaces (æ¥å£å±‚)
â”œâ”€â”€ IDroneRepository
â””â”€â”€ ITaskRepository
```

## ğŸ”„ è¿ç§»æ­¥éª¤

### 1. ä¾èµ–æ³¨å…¥é…ç½®å·²æ›´æ–°

åœ¨ `Program.cs` ä¸­å·²æ·»åŠ æ–°çš„æœåŠ¡æ³¨å†Œï¼š

```csharp
// æ•°æ®è®¿é—®å±‚
builder.Services.AddScoped<IDroneRepository, DroneRepository>();
builder.Services.AddScoped<ITaskRepository, TaskRepository>();

// ä¸šåŠ¡æœåŠ¡å±‚
builder.Services.AddScoped<DroneService>();
builder.Services.AddScoped<TaskService>();

// åŸæœ‰æœåŠ¡ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
builder.Services.AddSingleton<DroneDataService>();
builder.Services.AddSingleton<TaskDataService>();
```

### 2. æ–°æ§åˆ¶å™¨å·²åˆ›å»º

- `NewDronesController` - ä½¿ç”¨æ–°çš„ `DroneService`
- `NewTasksController` - ä½¿ç”¨æ–°çš„ `TaskService`

### 3. é…ç½®å·²æ›´æ–°

åœ¨ `appsettings.json` ä¸­æ·»åŠ äº† `DataService` é…ç½®ï¼š

```json
{
  "DataService": {
    "MaxRetryAttempts": 3,
    "CacheExpirationMinutes": 10,
    "MaxConcurrentOperations": 10,
    "EnableRealTimeUpdates": true,
    "BatchSize": 50,
    "EnablePerformanceMonitoring": true,
    "DatabaseTimeoutSeconds": 30,
    "EnableConnectionPooling": true,
    "MaxPoolSize": 100,
    "MinPoolSize": 5
  }
}
```

## ğŸš€ ä½¿ç”¨æ–°API

### æ— äººæœºAPI

**åŸæœ‰API:**
```
GET /api/drones
GET /api/drones/{id}
POST /api/drones
PUT /api/drones/{id}
DELETE /api/drones/{id}
```

**æ–°API:**
```
GET /api/newdrones
GET /api/newdrones/{id}
GET /api/newdrones/name/{droneName}
POST /api/newdrones
PUT /api/newdrones/{id}
DELETE /api/newdrones/{id}
GET /api/newdrones/cluster/status
GET /api/newdrones/{id}/data
GET /api/newdrones/data/all
PUT /api/newdrones/bulk
GET /api/newdrones/statistics
```

### ä»»åŠ¡API

**åŸæœ‰API:**
```
GET /api/historydata/tasks/all
GET /api/historydata/task/{taskId}
```

**æ–°API:**
```
GET /api/newtasks
GET /api/newtasks/{id}
POST /api/newtasks
PUT /api/newtasks/{id}
DELETE /api/newtasks/{id}
GET /api/newtasks/{id}/subtasks
GET /api/newtasks/{taskId}/subtasks/{subTaskId}
POST /api/newtasks/{taskId}/subtasks
PUT /api/newtasks/{taskId}/subtasks/{subTaskId}
DELETE /api/newtasks/{taskId}/subtasks/{subTaskId}
GET /api/newtasks/{taskId}/subtasks/{subTaskId}/images
GET /api/newtasks/images/{imageId}
POST /api/newtasks/{taskId}/subtasks/{subTaskId}/images
DELETE /api/newtasks/images/{imageId}
GET /api/newtasks/{taskId}/data/{droneId}
PUT /api/newtasks/bulk
GET /api/newtasks/statistics
GET /api/newtasks/status/statistics
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åŸæœ‰æ¶æ„
- âŒ æ§åˆ¶å™¨ç›´æ¥è®¿é—®æ•°æ®åº“æœåŠ¡
- âŒ ç¼ºä¹ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£
- âŒ ç¼“å­˜é€»è¾‘åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡ä¸­
- âŒ éš¾ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•

### æ–°æ¶æ„
- âœ… æ¸…æ™°çš„åˆ†å±‚èŒè´£
- âœ… ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£
- âœ… é›†ä¸­çš„ç¼“å­˜ç®¡ç†
- âœ… æ˜“äºå•å…ƒæµ‹è¯•
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†
- âœ… æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

## ğŸ”§ é€æ­¥è¿ç§»å»ºè®®

### é˜¶æ®µ1: å¹¶è¡Œè¿è¡Œï¼ˆå½“å‰çŠ¶æ€ï¼‰
- ä¿æŒåŸæœ‰APIå¯ç”¨
- æ–°APIé€šè¿‡ `/api/newdrones` å’Œ `/api/newtasks` è®¿é—®
- é€æ­¥å°†å‰ç«¯è¿ç§»åˆ°æ–°API

### é˜¶æ®µ2: å®Œå…¨è¿ç§»
- å°†åŸæœ‰æ§åˆ¶å™¨é‡å‘½åä¸º `LegacyDronesController`
- å°†æ–°æ§åˆ¶å™¨é‡å‘½åä¸º `DronesController`
- æ›´æ–°æ‰€æœ‰å‰ç«¯è°ƒç”¨

### é˜¶æ®µ3: æ¸…ç†
- ç§»é™¤æ—§çš„æœåŠ¡å’Œæ§åˆ¶å™¨
- æ¸…ç†ä¸å†ä½¿ç”¨çš„ä»£ç 

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
```csharp
// æµ‹è¯•æ•°æ®è®¿é—®å±‚
[Test]
public async Task DroneRepository_GetByIdAsync_ShouldReturnDrone()
{
    // Arrange
    var mockSqlserverService = new Mock<SqlserverService>();
    var repository = new DroneRepository(mockSqlserverService.Object, logger);
    
    // Act
    var result = await repository.GetByIdAsync(droneId);
    
    // Assert
    Assert.IsNotNull(result);
}
```

### é›†æˆæµ‹è¯•
```csharp
// æµ‹è¯•ä¸šåŠ¡æœåŠ¡å±‚
[Test]
public async Task DroneService_GetDronesAsync_ShouldReturnCachedData()
{
    // Arrange
    var mockRepository = new Mock<IDroneRepository>();
    var service = new DroneService(mockRepository.Object, logger, cache, options);
    
    // Act
    var result1 = await service.GetDronesAsync();
    var result2 = await service.GetDronesAsync();
    
    // Assert
    Assert.AreEqual(result1, result2); // ç¬¬äºŒæ¬¡åº”è¯¥ä»ç¼“å­˜è¿”å›
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸€è‡´æ€§**: æ–°æ¶æ„ä½¿ç”¨Scopedç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
2. **ç¼“å­˜ç­–ç•¥**: æ–°æ¶æ„æœ‰æ›´å®Œå–„çš„ç¼“å­˜å¤±æ•ˆç­–ç•¥
3. **é”™è¯¯å¤„ç†**: æ–°æ¶æ„æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—
4. **æ€§èƒ½ç›‘æ§**: æ–°æ¶æ„å†…ç½®æ€§èƒ½ç»Ÿè®¡å’Œç›‘æ§åŠŸèƒ½

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

æ–°æ¶æ„æä¾›ä»¥ä¸‹ç›‘æ§æŒ‡æ ‡ï¼š

- æ€»æ“ä½œæ¬¡æ•°
- ç¼“å­˜å‘½ä¸­ç‡
- å¹³å‡å“åº”æ—¶é—´
- æ•°æ®åº“è¿æ¥çŠ¶æ€
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- æ´»è·ƒè¿æ¥æ•°

## ğŸ†˜ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä¾èµ–æ³¨å…¥é”™è¯¯**
   - æ£€æŸ¥ `Program.cs` ä¸­çš„æœåŠ¡æ³¨å†Œ
   - ç¡®ä¿æ‰€æœ‰å¿…è¦çš„æœåŠ¡éƒ½å·²æ³¨å†Œ

2. **ç¼“å­˜é—®é¢˜**
   - æ£€æŸ¥ç¼“å­˜é…ç½®
   - éªŒè¯ç¼“å­˜é”®çš„ä¸€è‡´æ€§

3. **æ•°æ®åº“è¿æ¥é—®é¢˜**
   - æ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²é…ç½®
   - éªŒè¯æ•°æ®åº“æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

### æ—¥å¿—æŸ¥çœ‹

æ–°æ¶æ„æä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ï¼š

```csharp
// åœ¨æ§åˆ¶å™¨ä¸­
_logger.LogInformation("æ“ä½œæˆåŠŸ: {Operation}", operationName);
_logger.LogError(ex, "æ“ä½œå¤±è´¥: {Operation}", operationName);
```

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. åº”ç”¨ç¨‹åºæ—¥å¿—
2. æ€§èƒ½ç›‘æ§æŒ‡æ ‡
3. æ•°æ®åº“è¿æ¥çŠ¶æ€
4. ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ 