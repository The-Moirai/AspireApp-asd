# ç¼“å­˜ä¼˜åŒ–ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

åŸºäºRedisè¯Šæ–­æµ‹è¯•çš„æˆåŠŸç»“æœï¼ˆæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå¹³å‡å“åº”æ—¶é—´1-3msï¼‰ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ä¼˜åŒ–çš„åˆ†å±‚ç¼“å­˜ç³»ç»Ÿã€‚æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å……åˆ†åˆ©ç”¨ç¼“å­˜æ€§èƒ½ï¼Œæå‡åº”ç”¨å“åº”é€Ÿåº¦ã€‚

## æµ‹è¯•ç»“æœåˆ†æ

### âœ… æµ‹è¯•é€šè¿‡æƒ…å†µ
- **åŸºç¡€è¿æ¥æµ‹è¯•**: è¿æ¥æˆåŠŸï¼Œå“åº”æ—¶é—´3.89ms
- **é…ç½®æ£€æŸ¥**: è¿æ¥å­—ç¬¦ä¸²æ­£ç¡®ï¼ŒConnectionMultiplexerå·²è¿æ¥
- **ç½‘ç»œè¿æ¥æµ‹è¯•**: ç½‘ç»œè¿æ¥æ­£å¸¸ï¼ŒRediså“åº”æ—¶é—´1.54ms
- **æƒé™æµ‹è¯•**: è¯»å†™åˆ é™¤æƒé™æ­£å¸¸
- **æ€§èƒ½æµ‹è¯•**: æ€§èƒ½æµ‹è¯•å®Œæˆï¼Œæ€»æ—¶é—´29msï¼Œå¹³å‡2ms/æ¬¡ï¼Œæ“ä½œæ•°10
- **å¥åº·æ£€æŸ¥**: RedisæœåŠ¡å¥åº·ï¼ŒPINGå“åº”æ—¶é—´1.32ms

### ğŸ“Š æ€§èƒ½æŒ‡æ ‡
- å¹³å‡å“åº”æ—¶é—´: 1-3ms
- æ€§èƒ½æµ‹è¯•æˆåŠŸç‡: 100%
- è¿æ¥ç¨³å®šæ€§: ä¼˜ç§€
- ç½‘ç»œå»¶è¿Ÿ: æä½

## ç¼“å­˜æ¶æ„

### åˆ†å±‚ç¼“å­˜ç­–ç•¥
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å†…å­˜ç¼“å­˜      â”‚ â† æœ€å¿«è®¿é—® (1-2ms)
â”‚  (L1 Cache)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Redisç¼“å­˜     â”‚ â† æŒä¹…åŒ–å­˜å‚¨ (1-3ms)
â”‚  (L2 Cache)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“        â”‚ â† æ•°æ®æº (10-100ms)
â”‚  (Data Source)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼“å­˜ä¼˜å…ˆçº§
- **Critical**: å®æ—¶æ•°æ®ï¼Œ1åˆ†é’Ÿå†…å­˜ç¼“å­˜
- **High**: é«˜é¢‘è®¿é—®æ•°æ®ï¼Œ2åˆ†é’Ÿå†…å­˜ç¼“å­˜
- **Medium**: å¸¸è§„æ•°æ®ï¼Œ5åˆ†é’Ÿå†…å­˜ç¼“å­˜
- **Low**: å†å²æ•°æ®ï¼Œ10åˆ†é’Ÿå†…å­˜ç¼“å­˜

## ä½¿ç”¨æŒ‡å—

### 1. åŸºæœ¬ç¼“å­˜æ“ä½œ

#### è·å–ç¼“å­˜
```csharp
// ä½¿ç”¨ä¼˜åŒ–çš„ç¼“å­˜æœåŠ¡
var drone = await _optimizedCacheService.GetAsync<Drone>("drone:123", CachePriority.High);
```

#### è®¾ç½®ç¼“å­˜
```csharp
// è®¾ç½®ç¼“å­˜ï¼ŒæŒ‡å®šä¼˜å…ˆçº§
await _optimizedCacheService.SetAsync("drone:123", drone, TimeSpan.FromMinutes(30), CachePriority.High);
```

#### è·å–æˆ–è®¾ç½®ç¼“å­˜
```csharp
// ç¼“å­˜é¢„çƒ­æ¨¡å¼
var drones = await _optimizedCacheService.GetOrSetAsync("drones:all", 
    async () => await _droneRepository.GetAllAsync(), 
    TimeSpan.FromMinutes(15), 
    CachePriority.Medium);
```

### 2. æ‰¹é‡æ“ä½œ

#### æ‰¹é‡è·å–
```csharp
var keys = new[] { "drone:1", "drone:2", "drone:3" };
var drones = await _optimizedCacheService.GetMultipleAsync<Drone>(keys, CachePriority.High);
```

#### æ‰¹é‡è®¾ç½®
```csharp
var droneDict = drones.ToDictionary(d => $"drone:{d.Id}", d => d);
await _optimizedCacheService.SetMultipleAsync(droneDict, TimeSpan.FromMinutes(30), CachePriority.High);
```

### 3. ç¼“å­˜ç®¡ç†

#### æ£€æŸ¥ç¼“å­˜å­˜åœ¨æ€§
```csharp
var exists = await _optimizedCacheService.ExistsAsync("drone:123");
```

#### ç§»é™¤ç¼“å­˜
```csharp
await _optimizedCacheService.RemoveAsync("drone:123");
```

#### åˆ·æ–°ç¼“å­˜
```csharp
await _optimizedCacheService.RefreshAsync("drone:123");
```

## æœ€ä½³å®è·µ

### 1. ç¼“å­˜é”®å‘½åè§„èŒƒ
```
// æ¨èæ ¼å¼: {ä¸šåŠ¡æ¨¡å—}:{æ•°æ®ç±»å‹}:{æ ‡è¯†ç¬¦}
"drones:all"                    // æ‰€æœ‰æ— äººæœº
"drone:123:status"              // æ— äººæœºçŠ¶æ€
"tasks:active"                  // æ´»è·ƒä»»åŠ¡
"task:456:subtasks"             // ä»»åŠ¡å­é¡¹
"images:task:789:recent"        // æœ€è¿‘å›¾ç‰‡
```

### 2. ä¼˜å…ˆçº§é€‰æ‹©ç­–ç•¥
```csharp
// å®æ—¶æ•°æ® - Criticalä¼˜å…ˆçº§
await _optimizedCacheService.SetAsync($"drone:{droneId}:realtime", data, null, CachePriority.Critical);

// é«˜é¢‘è®¿é—®æ•°æ® - Highä¼˜å…ˆçº§
await _optimizedCacheService.SetAsync("drones:all", drones, TimeSpan.FromMinutes(15), CachePriority.High);

// å¸¸è§„æ•°æ® - Mediumä¼˜å…ˆçº§
await _optimizedCacheService.SetAsync($"task:{taskId}", task, TimeSpan.FromMinutes(30), CachePriority.Medium);

// å†å²æ•°æ® - Lowä¼˜å…ˆçº§
await _optimizedCacheService.SetAsync($"history:{date}", historyData, TimeSpan.FromHours(2), CachePriority.Low);
```

### 3. ç¼“å­˜é¢„çƒ­ç­–ç•¥
```csharp
// åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­å…³é”®æ•°æ®
public async Task WarmupCacheAsync()
{
    // é¢„çƒ­æ‰€æœ‰æ— äººæœºæ•°æ®
    await _optimizedCacheService.GetOrSetAsync("drones:all", 
        async () => await _droneRepository.GetAllAsync(), 
        TimeSpan.FromMinutes(15), 
        CachePriority.High);

    // é¢„çƒ­æ´»è·ƒä»»åŠ¡
    await _optimizedCacheService.GetOrSetAsync("tasks:active", 
        async () => await _taskRepository.GetActiveTasksAsync(), 
        TimeSpan.FromMinutes(10), 
        CachePriority.High);
}
```

### 4. ç¼“å­˜å¤±æ•ˆç­–ç•¥
```csharp
// æ•°æ®æ›´æ–°æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
public async Task UpdateDroneAsync(Drone drone)
{
    // æ›´æ–°æ•°æ®åº“
    await _droneRepository.UpdateAsync(drone);
    
    // æ¸…é™¤ç›¸å…³ç¼“å­˜
    await _optimizedCacheService.RemoveAsync($"drone:{drone.Id}");
    await _optimizedCacheService.RemoveAsync($"drone:{drone.Id}:status");
    await _optimizedCacheService.RemoveAsync("drones:all");
}
```

## ç›‘æ§å’Œç®¡ç†

### 1. ç¼“å­˜ç»Ÿè®¡API
```http
GET /api/cachemanagement/statistics
```

è¿”å›è¯¦ç»†çš„ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼š
- å†…å­˜ç¼“å­˜å‘½ä¸­ç‡
- Redisç¼“å­˜å‘½ä¸­ç‡
- æ€»ä½“å‘½ä¸­ç‡
- ç¼“å­˜æœªå‘½ä¸­ç‡

### 2. æ€§èƒ½æŠ¥å‘ŠAPI
```http
GET /api/cachemanagement/performance-report
```

æä¾›æ€§èƒ½åˆ†æå’Œä¼˜åŒ–å»ºè®®ã€‚

### 3. ç¼“å­˜ç®¡ç†API
```http
# æ£€æŸ¥ç¼“å­˜é¡¹
GET /api/cachemanagement/exists/{key}

# ç§»é™¤ç¼“å­˜é¡¹
DELETE /api/cachemanagement/remove/{key}

# åˆ·æ–°ç¼“å­˜é¡¹
POST /api/cachemanagement/refresh/{key}

# æ¸…é™¤æ‰€æœ‰ç¼“å­˜
POST /api/cachemanagement/clear-all

# æ‰¹é‡ç§»é™¤
POST /api/cachemanagement/batch-remove
Body: ["key1", "key2", "key3"]
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. åŸºäºæµ‹è¯•ç»“æœçš„ä¼˜åŒ–
- **åˆ©ç”¨ä½å»¶è¿Ÿä¼˜åŠ¿**: Rediså“åº”æ—¶é—´ä»…1-3msï¼Œå¯ä»¥é¢‘ç¹è®¿é—®
- **å†…å­˜ç¼“å­˜ä¼˜å…ˆ**: å¯¹äºé«˜é¢‘æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨å†…å­˜ç¼“å­˜
- **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨æ‰¹é‡APIå‡å°‘ç½‘ç»œå¾€è¿”

### 2. ç¼“å­˜ç­–ç•¥è°ƒæ•´
```csharp
// å®æ—¶æ•°æ® - æ›´çŸ­çš„è¿‡æœŸæ—¶é—´
await _optimizedCacheService.SetAsync(key, value, TimeSpan.FromSeconds(30), CachePriority.Critical);

// é™æ€æ•°æ® - æ›´é•¿çš„è¿‡æœŸæ—¶é—´
await _optimizedCacheService.SetAsync(key, value, TimeSpan.FromHours(1), CachePriority.Low);
```

### 3. é”™è¯¯å¤„ç†å’Œé™çº§
```csharp
try
{
    var data = await _optimizedCacheService.GetAsync<T>(key);
    return data;
}
catch (Exception ex)
{
    _logger.LogWarning(ex, "ç¼“å­˜è®¿é—®å¤±è´¥ï¼Œé™çº§åˆ°æ•°æ®åº“");
    return await _repository.GetAsync(id);
}
```

## é…ç½®è¯´æ˜

### appsettings.json é…ç½®
```json
{
  "Cache": {
    "Redis": {
      "InstanceName": "AspireApp_",
      "DefaultExpirationMinutes": 30,
      "ShortTermExpirationMinutes": 5,
      "LongTermExpirationMinutes": 120,
      "EnableCompression": true,
      "EnableSerializationOptimization": true
    },
    "Memory": {
      "SizeLimit": 1000,
      "CompactionPercentage": 0.1,
      "ExpirationScanFrequency": "00:05:00"
    },
    "Strategy": {
      "EnableTieredCaching": true,
      "EnableCacheWarming": true,
      "EnableCacheInvalidation": true,
      "EnableCacheStatistics": true,
      "RealTimeDataPriority": "High",
      "HistoricalDataPriority": "Medium"
    }
  }
}
```

## æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜
- **ç¼“å­˜æœªå‘½ä¸­ç‡é«˜**: æ£€æŸ¥ç¼“å­˜é”®ç­–ç•¥å’Œè¿‡æœŸæ—¶é—´
- **å†…å­˜ä½¿ç”¨è¿‡é«˜**: è°ƒæ•´å†…å­˜ç¼“å­˜å¤§å°é™åˆ¶
- **Redisè¿æ¥å¤±è´¥**: ä½¿ç”¨è¯Šæ–­APIæ£€æŸ¥è¿æ¥çŠ¶æ€

### 2. è¯Šæ–­å·¥å…·
```http
# Redisè¿æ¥è¯Šæ–­
POST /api/redisdiagnostic/diagnose

# ç¼“å­˜æ€§èƒ½æµ‹è¯•
POST /api/cachemanagement/performance-test?iterations=100
```

## æ€»ç»“

åŸºäºRedisæµ‹è¯•çš„ä¼˜ç§€ç»“æœï¼Œæˆ‘ä»¬çš„ç¼“å­˜ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **æä½å»¶è¿Ÿ**: 1-3mså“åº”æ—¶é—´
2. **é«˜å¯é æ€§**: 100%æµ‹è¯•é€šè¿‡ç‡
3. **åˆ†å±‚æ¶æ„**: å†…å­˜+RedisåŒé‡ç¼“å­˜
4. **æ™ºèƒ½ç®¡ç†**: è‡ªåŠ¨ç»Ÿè®¡å’Œä¼˜åŒ–å»ºè®®
5. **çµæ´»é…ç½®**: æ”¯æŒä¸åŒä¼˜å…ˆçº§å’Œè¿‡æœŸç­–ç•¥

é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›åŠŸèƒ½ï¼Œå¯ä»¥æ˜¾è‘—æå‡åº”ç”¨æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚ 