# 性能监控使用指南

## 概述

本系统已集成完整的性能监控功能，包括实时性能数据收集、历史数据分析、性能警告和系统健康检查。通过新的统计功能，您可以全面监控系统性能并快速识别潜在问题。

## 监控架构

### 1. 性能监控服务 (PerformanceMonitoringService)
- **功能**: 收集系统级性能指标
- **数据**: CPU使用率、内存使用、线程数、请求统计等
- **存储**: 内存缓存，支持历史数据查询

### 2. 业务服务统计 (DroneService/TaskService)
- **功能**: 收集业务级性能指标
- **数据**: 缓存命中率、响应时间、操作统计等
- **存储**: 实时统计，支持查询

### 3. 性能监控中间件 (PerformanceMonitoringMiddleware)
- **功能**: 自动收集HTTP请求性能数据
- **数据**: 请求响应时间、错误率、请求频率等
- **特点**: 透明集成，无需修改业务代码

## API端点

### 性能监控控制器 (/api/performance)

#### 1. 系统概览
```http
GET /api/performance/overview
```
**返回数据**:
- 系统资源使用情况
- 服务状态统计
- 性能指标汇总
- 实时警告信息

#### 2. 无人机服务统计
```http
GET /api/performance/drone-stats
```
**返回数据**:
- 无人机总数和在线数量
- 缓存命中率和响应时间
- 数据库连接状态
- 操作统计信息

#### 3. 任务服务统计
```http
GET /api/performance/task-stats
```
**返回数据**:
- 任务总数和活跃数量
- 缓存命中率和响应时间
- 数据库连接状态
- 操作统计信息

#### 4. 当前性能指标
```http
GET /api/performance/current
```
**返回数据**:
- 实时CPU和内存使用率
- 请求频率和响应时间
- 异常统计
- 活跃连接数

#### 5. 资源使用情况
```http
GET /api/performance/resources
```
**返回数据**:
- 内存使用详情（工作集、私有内存、虚拟内存）
- 垃圾回收统计
- 系统线程和句柄数
- 进程运行时间

#### 6. 缓存统计
```http
GET /api/performance/cache-stats
```
**返回数据**:
- 各服务缓存命中率
- 缓存操作统计
- 总体缓存性能

#### 7. 系统健康状态
```http
GET /api/performance/health
```
**返回数据**:
- 整体健康状态
- 各组件健康检查结果
- 性能指标状态

### 仪表板控制器 (/api/dashboard)

#### 1. 仪表板概览
```http
GET /api/dashboard/overview
```
**返回数据**:
- 系统状态概览
- 服务运行状态
- 性能指标摘要
- 警告信息

#### 2. 性能图表数据
```http
GET /api/dashboard/charts/performance?hours=6
```
**返回数据**:
- 时间序列图表数据
- CPU、内存、响应时间趋势
- 适用于前端图表库

#### 3. 服务状态图表
```http
GET /api/dashboard/charts/services
```
**返回数据**:
- 无人机在线/离线比例
- 任务活跃/完成比例
- 缓存命中/未命中比例

#### 4. 系统快照
```http
GET /api/dashboard/snapshot
```
**返回数据**:
- 系统运行状态
- 版本和环境信息
- 服务健康状态
- 性能指标汇总

## 配置选项

### appsettings.json 性能监控配置

```json
{
  "Performance": {
    "Enabled": true,
    "CollectionIntervalSeconds": 30,
    "HistoryRetentionHours": 24,
    "MaxHistoryPoints": 2880,
    "CpuWarningThreshold": 80.0,
    "MemoryWarningThresholdMB": 1024.0,
    "ResponseTimeWarningThresholdMs": 1000.0,
    "EnableDetailedLogging": false,
    "EnableAlerts": true,
    "AlertCheckIntervalSeconds": 60,
    "CacheStatsIntervalSeconds": 10,
    "EnableRequestTracing": true,
    "RequestTracingSampleRate": 0.1,
    "SlowQueryThresholdMs": 500.0,
    "EnableDatabaseMonitoring": true,
    "DatabaseTimeoutThresholdMs": 5000.0
  }
}
```

### 配置说明

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| Enabled | true | 是否启用性能监控 |
| CollectionIntervalSeconds | 30 | 性能数据收集间隔（秒） |
| HistoryRetentionHours | 24 | 历史数据保留时间（小时） |
| MaxHistoryPoints | 2880 | 最大历史数据点数量 |
| CpuWarningThreshold | 80.0 | CPU使用率警告阈值（%） |
| MemoryWarningThresholdMB | 1024.0 | 内存使用率警告阈值（MB） |
| ResponseTimeWarningThresholdMs | 1000.0 | 响应时间警告阈值（毫秒） |
| EnableDetailedLogging | false | 是否启用详细日志记录 |
| EnableAlerts | true | 是否启用性能警告 |
| AlertCheckIntervalSeconds | 60 | 性能警告检查间隔（秒） |
| CacheStatsIntervalSeconds | 10 | 缓存统计收集间隔（秒） |
| EnableRequestTracing | true | 是否启用请求追踪 |
| RequestTracingSampleRate | 0.1 | 请求追踪采样率（0.0-1.0） |
| SlowQueryThresholdMs | 500.0 | 慢查询阈值（毫秒） |
| EnableDatabaseMonitoring | true | 是否启用数据库性能监控 |
| DatabaseTimeoutThresholdMs | 5000.0 | 数据库查询超时阈值（毫秒） |

## 使用示例

### 1. 前端集成示例

```javascript
// 获取系统概览
async function getSystemOverview() {
    const response = await fetch('/api/performance/overview');
    const data = await response.json();
    
    if (data.success) {
        updateDashboard(data.data);
    }
}

// 获取性能图表数据
async function getPerformanceCharts(hours = 6) {
    const response = await fetch(`/api/dashboard/charts/performance?hours=${hours}`);
    const data = await response.json();
    
    if (data.success) {
        updateCharts(data.data);
    }
}

// 定期刷新数据
setInterval(getSystemOverview, 30000); // 每30秒刷新一次
setInterval(() => getPerformanceCharts(6), 60000); // 每60秒刷新图表
```

### 2. 健康检查集成

```javascript
// 系统健康检查
async function checkSystemHealth() {
    const response = await fetch('/api/performance/health');
    const data = await response.json();
    
    if (data.success) {
        const health = data.data;
        
        if (health.overall === 'Healthy') {
            showSuccessMessage('系统运行正常');
        } else {
            showWarningMessage('系统存在性能问题');
        }
    }
}
```

### 3. 性能警告处理

```javascript
// 监听性能警告
async function monitorPerformanceAlerts() {
    const response = await fetch('/api/performance/alerts?count=10');
    const data = await response.json();
    
    if (data.success && data.data.length > 0) {
        data.data.forEach(alert => {
            showAlert(alert.message, alert.level);
        });
    }
}
```

## 监控最佳实践

### 1. 设置合理的阈值
- CPU使用率警告阈值：80%
- 内存使用率警告阈值：1024MB
- 响应时间警告阈值：1000ms
- 数据库查询超时阈值：5000ms

### 2. 定期检查关键指标
- 系统资源使用率
- 服务响应时间
- 缓存命中率
- 数据库连接状态
- 异常发生频率

### 3. 性能优化建议
- 监控缓存命中率，低于80%时考虑优化缓存策略
- 关注响应时间趋势，持续增长时及时排查
- 定期检查内存使用情况，避免内存泄漏
- 监控数据库查询性能，优化慢查询

### 4. 告警策略
- 设置多级告警（信息、警告、严重）
- 配置告警通知渠道
- 建立告警响应流程
- 定期回顾和调整告警规则

## 故障排查

### 1. 性能问题排查步骤
1. 检查系统概览API返回的数据
2. 分析性能图表趋势
3. 查看性能警告历史
4. 检查资源使用情况
5. 分析缓存统计信息

### 2. 常见问题及解决方案

#### 高CPU使用率
- 检查是否有长时间运行的查询
- 分析请求频率是否异常
- 查看是否有内存泄漏导致频繁GC

#### 高内存使用率
- 检查缓存大小设置
- 分析内存分配模式
- 查看垃圾回收频率

#### 响应时间过长
- 检查数据库查询性能
- 分析缓存命中率
- 查看网络连接状态

#### 缓存命中率低
- 检查缓存策略设置
- 分析数据访问模式
- 考虑增加缓存容量

## 扩展功能

### 1. 自定义监控指标
可以通过扩展PerformanceMonitoringService来添加自定义监控指标：

```csharp
public class CustomMetrics
{
    public int CustomCounter { get; set; }
    public double CustomGauge { get; set; }
    public string CustomStatus { get; set; }
}
```

### 2. 外部监控系统集成
支持与Prometheus、Grafana等外部监控系统集成：

```csharp
// 添加Prometheus指标导出
app.UseMetricServer();
app.UseHttpMetrics();
```

### 3. 日志聚合
支持与ELK Stack等日志聚合系统集成，提供更详细的性能分析。

## 总结

通过本性能监控系统，您可以：

1. **实时监控**：获取系统实时性能状态
2. **历史分析**：查看性能趋势和变化
3. **预警机制**：及时发现性能问题
4. **健康检查**：确保系统稳定运行
5. **数据驱动**：基于性能数据优化系统

建议定期查看性能监控数据，建立性能基线，并根据业务需求调整监控策略。 